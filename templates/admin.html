{% extends 'base.html' %}

{% block content %}
<header class="hero admin-hero">
    <div class="hero__copy">
        <p class="badge">Administração</p>
        <h1>Gerencie partidas direto no Supabase</h1>
        <p>
            Cadastro rápido de novos jogos e manutenção do histórico existente.
            Use a lista de jogadores para evitar digitação duplicada e mantenha
            o calendário sempre atualizado.
        </p>
    </div>
</header>

{% if feedback %}
<div class="alert {{ 'success' if feedback.status == 'success' else 'error' }}">
    {{ feedback.message }}
</div>
{% endif %}

{% if requires_auth and not authenticated %}
<section class="panel">
    <div class="section-title">
        <h2>Área restrita</h2>
        <span class="meta">Informe a senha para continuar</span>
    </div>
    <form class="form-grid" method="post">
        <input type="hidden" name="action" value="login" />
        <label>
            <span class="badge">Senha</span>
            <input type="password" name="password" placeholder="Digite a senha" class="input" required />
        </label>
        <div class="form-actions">
            <button type="submit" class="btn-primary">Entrar</button>
        </div>
    </form>
</section>
{% else %}
<section class="panel">
    <div class="section-title">
        <h2>Atualizar dados</h2>
        <span class="meta">Recarregue o cache de partidas do Supabase</span>
    </div>
    <form method="post" class="form-actions">
        <input type="hidden" name="action" value="refresh" />
        <button class="btn-secondary" type="submit">Atualizar dados do Supabase</button>
    </form>
</section>

<section class="panel">
    <div class="section-title">
        <h2>Jogadores cadastrados</h2>
        <span class="meta">Adicione novos nomes e copie a lista completa</span>
    </div>
    <form class="form-grid" method="post">
        <input type="hidden" name="action" value="add_player" />
        <label>
            <span class="badge">Novo jogador</span>
            <input class="input" name="player_name" placeholder="Nome" required />
        </label>
        <div class="form-actions">
            <button class="btn-primary" type="submit">Cadastrar jogador</button>
        </div>
    </form>
    <div class="form-grid" style="margin-top: 12px;">
        <label>
            <span class="badge">Lista completa</span>
            <textarea id="players-text" class="input" readonly rows="6">{{ players_text }}</textarea>
        </label>
        <div class="form-actions">
            <button class="btn-secondary" type="button" id="copy-players">Copiar lista</button>
        </div>
    </div>
</section>

<section class="panel">
    <div class="section-title">
        <h2>Cadastrar nova partida</h2>
        <span class="meta">Preencha os quatro jogadores e a data do jogo</span>
    </div>
    <form class="form-grid" method="post">
        <input type="hidden" name="action" value="create" />
        <datalist id="players-list">
            {% for player in players %}
            <option value="{{ player }}"></option>
            {% endfor %}
        </datalist>
        <label>
            <span class="badge">Vencedor 1</span>
            <input class="input" name="winner1" list="players-list" placeholder="Nome" required />
        </label>
        <label>
            <span class="badge">Vencedor 2</span>
            <input class="input" name="winner2" list="players-list" placeholder="Nome" required />
        </label>
        <label>
            <span class="badge">Perdedor 1</span>
            <input class="input" name="loser1" list="players-list" placeholder="Nome" required />
        </label>
        <label>
            <span class="badge">Perdedor 2</span>
            <input class="input" name="loser2" list="players-list" placeholder="Nome" required />
        </label>
        <label>
            <span class="badge">Data</span>
            <input class="input" type="date" name="date" value="{{ today }}" required />
        </label>
        <div class="form-actions">
            <button class="btn-primary" type="submit">Cadastrar partida</button>
            {% if role != 'full' %}
            <p class="meta">Edição e exclusão ficam disponíveis apenas para administradores completos.</p>
            {% endif %}
        </div>
    </form>
</section>

<section class="panel">
    <div class="section-title">
        <h2>Lançar partidas em bloco</h2>
        <span class="meta">Use o formato "jogador_a e jogador_b x jogador_c e jogador_d" por linha</span>
    </div>
    <form class="form-grid" method="post">
        <input type="hidden" name="action" value="bulk_create" />
        <label>
            <span class="badge">Data das partidas</span>
            <input class="input" type="date" name="bulk_date" value="{{ today }}" />
        </label>
        <label style="grid-column: 1 / -1;">
            <span class="badge">Partidas</span>
            <textarea class="input" name="bulk_matches" rows="6" placeholder="jogador_a e jogador_b x jogador_c e jogador_d&#10;jogador_b e jogador_b x jogador_k e jogador_d" required></textarea>
        </label>
        <div class="form-actions">
            <button class="btn-primary" type="submit">Cadastrar partidas em bloco</button>
        </div>
    </form>
</section>

<section class="panel" style="margin-top: 18px;">
    <div class="section-title">
        <h2>Partidas cadastradas</h2>
        <span class="meta">Atualize ou remova registros diretamente</span>
    </div>
    {% if matches %}
    <div class="match-grid">
        {% for match in matches %}
        <form class="match-card" method="post">
            <input type="hidden" name="match_id" value="{{ match._identifier_value }}" />
            <input type="hidden" name="id_field" value="{{ match._identifier_field }}" />
            <div class="match-card__header">
                <div>
                    <p class="badge">{{ match.date.isoformat() if match.date else 'Sem data' }}</p>
                    <strong>{{ match.winner1 }} &amp; {{ match.winner2 }} x {{ match.loser1 }} &amp; {{ match.loser2 }}</strong>
                    {% if match.identifier_display %}
                    <p class="meta">ID: {{ match.identifier_display }}</p>
                    {% endif %}
                </div>
                <div class="match-card__actions">
                    <button class="btn-primary" type="submit" name="action" value="update" {% if role != 'full' %}disabled{% endif %}>Salvar</button>
                    <button class="btn-secondary" type="submit" name="action" value="delete" {% if role != 'full' %}disabled{% endif %}>Excluir</button>
                </div>
            </div>
            <div class="form-grid compact">
                <label>
                    <span class="badge">Vencedor 1</span>
                    <input class="input" name="winner1" list="players-list" value="{{ match.winner1 }}" required {% if role != 'full' %}readonly{% endif %} />
                </label>
                <label>
                    <span class="badge">Vencedor 2</span>
                    <input class="input" name="winner2" list="players-list" value="{{ match.winner2 }}" required {% if role != 'full' %}readonly{% endif %} />
                </label>
                <label>
                    <span class="badge">Perdedor 1</span>
                    <input class="input" name="loser1" list="players-list" value="{{ match.loser1 }}" required {% if role != 'full' %}readonly{% endif %} />
                </label>
                <label>
                    <span class="badge">Perdedor 2</span>
                    <input class="input" name="loser2" list="players-list" value="{{ match.loser2 }}" required {% if role != 'full' %}readonly{% endif %} />
                </label>
                <label>
                    <span class="badge">Data</span>
                    <input class="input" type="date" name="date" value="{{ match.date.isoformat() if match.date else '' }}" required {% if role != 'full' %}readonly{% endif %} />
                </label>
            </div>
        </form>
        {% endfor %}
    </div>
    {% else %}
    <p class="meta">Nenhuma partida cadastrada até o momento.</p>
    {% endif %}
</section>
{% endif %}

{% if authenticated and requires_auth %}
<form method="post" class="logout-form">
    <input type="hidden" name="action" value="logout" />
    <button type="submit" class="btn-secondary">Encerrar sessão</button>
</form>
{% endif %}

<script>
    const copyButton = document.getElementById('copy-players');
    const playersText = document.getElementById('players-text');
    if (copyButton && playersText) {
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(playersText.value.trim());
                copyButton.textContent = 'Copiado!';
                setTimeout(() => (copyButton.textContent = 'Copiar lista'), 2000);
            } catch (err) {
                copyButton.textContent = 'Erro ao copiar';
            }
        });
    }
</script>
{% endblock %}
